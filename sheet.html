<div class="container">

    <div class="header-container">
        <img class="logo" src="https://github.com/khtd/roll20_eotv/blob/master/EotV_Logotype_3.png?raw=true">

        <div class="name-container">
            <span class="name-label">Имя</span>
            <input type="text" class="name-input" name="attr_character_name">
        </div>

        <div class="class-container">
            <span class="class-label">Класс</span>
            <input type="hidden" name="attr_comp_name">
            <input type="hidden" name="attr_comp_classmoves">
            <span class="class-span" name="attr_character_class">Аристократ</span>
            <button type='action' class='change-button class-change-button' name='act_changeclass'>Изменить</button>
        </div>
    </div>

    <div class="navigation-container">
        <div class="nav-tabs">
            <label class="nav-button">
                <input type="radio"  name="attr_page" value="main" checked="checked">
                <span>Main</span>
            </label>
            <label class="nav-button">
                <input type="radio"  name="attr_page" value="sub">
                <span>Sub</span>
            </label>
        </div>
    </div>
    <input type='hidden' class='tabstoggle' name='attr_sheetTab'  value='main'/>


    <div class="page main-page">
        <div class='description'>
            <span name="attr_description"></span>
        </div>

        <div class="background">
            <h3><span>Происхождение</span></h3>
            <button type='action' name='act_changebackground'>Изменить</button><br>
            <span class='emptiable' name="attr_pre_background"></span><br>
            
            <button type='roll' class="sheet-backgroundOutput" name='roll_outBackground' value="&{template:info} {{name=@{character_name}}} {{type=Background}} {{item=Происхождение}} {{description=@{background}}}">w</button>
            <span class='emptiable' name="attr_background"></span><br>

            <input type="checkbox" class="background-show-flag" name="attr_background_show_flag" value="1">
            <div class='background-select'>
                <fieldset class='repeating_background'>
                    <button type="action" name="act_backgroundselect" value='@{attr_buttontext}'><span name='attr_buttontext'></span></button>
                    <span name="attr_backgroundtext"></span>
                </fieldset>
            </div>
        </div>

        <div class='cyborg-path'></div>

        <div class='stranger-specialty'></div>
    </div>

    <div class="page sub-page"></div>
</div>

<!-- Start welcome -->

<input type="checkbox" class="tip-confirm-flag" name="attr_tip_confirm_flag" value="1">
<div class="class-tip">
	<button type="action" class="cancel-button" name="act_cancelclass">&#128473;</button>
	<h3><span>Getting Started</span></h3>
	<p><span>Welcome to the Edge of The Verse Character Sheet!  To get started select class from the choices below:</span></p>
	<button type="action" name="act_noble">Аристократ</button>
	<button type="action" name="act_cyborg">Киборг</button>
</div>

<rolltemplate class="sheet-rolltemplate-info">
    <div class="sheet-templateMain">
        <h2 class="sheet-templateheader">{{name}}</h2>
        <h3 class="sheet-templatesubheader">{{item}}{{#type}} ({{type}}){{/type}}</h3>
        <div class="sheet-templatedescription">
            {{#description}}{{description}}{{/description}}
			{{#allprops() description item type}}<p><strong>{{key}}:</strong> {{value}}</p>{{/allprops() description item type}}
        </div>
    </div>
</rolltemplate>

<!-- type="text/worker" -->
<script type="text/worker">
    var classNames = {
        Noble: 'Аристократ',
        Cyborg: 'Киборг'
    }

    var descriptions = {
        Noble: `Хотя Федерация и пытается всеми силами оспорить первенство Империи, все-таки стоит признать, что после Дня Агонии именно последняя сумела по максимуму сохранить свои традиции и устои. Немаловажную роль в этом сыграли аристократы — привилегированный класс дворян, правящих доменами, из которых состоят миры под властью Императрицы. Но для тебя все сложилось иначе. У тебя нет собственного домена, а потому тебе предстоит самостоятельно найти место в этом мире. Но у тебя всё ещё остались честь, происхождение и жажда власти. А галактика — достаточно непредсказуемое место для того, чтобы дерзкий и смелый юноша мог в итоге сорвать куш и вернуться на родину баснословно богатым аристократом`,
        Cyborg: 'какой-то текст описания для киборга'
    }

    var backgrounds = {
        Noble: {
            preInfo: 'Выбери правящий дом, в котором ты рожден:',
            options: [
                {
                    button: 'Дом Адана',
                    text: 'Фехтование входит в обязательную программу обучения Дома. Твой Урон в ближнем бою увеличен на 1.'
                },
                {
                    button: 'Дом Акоста',
                    text: 'Сражаясь один на один в ближнем бою, ты можешь использовать Репутацию вместо Ярости.'
                },
                {
                    button: 'Дом Алуат',
                    text: 'Спокойный дом, склонный к наблюдению. Когда ты успешно Ориентируешься, задай на 1 вопрос больше.'
                },
                {
                    button: 'Дом Анхил',
                    text: 'Ты свой человек в криминальном мире. Потрать 1 Припас и поменяй в своём ID имя и другие данные.'
                },
                {
                    button: 'Дом Астор',
                    text: 'Твой дом баснословно влиятелен. Раз в сессию, когда Договариваешься, получи 10+. Рычаг всё ещё нужен.'
                },
                {
                    button: 'Дом Дега Росса',
                    text: 'Дом понимает в снабжении. Раз в сессию можешь достать любой не очень редкий предмет. Опиши, откуда.'
                },
                {
                    button: 'Малый дом',
                    text: 'Один раз за сессию ты можешь превратить 6— в 7—9 или 7—9 в 10+, если это пойдет на пользу Дому.'
                },
                {
                    button: 'Кастонианская марка',
                    text: 'Бароны и баронессы — самые гордые люди на свете. Когда ты Помогаешь, один раз в сессию ты можешь превратить проверку союзника в 10+.'
                },
                {
                    button: 'Эмираты Эльхали',
                    text: 'Ты — клон самого эмира, созданный лучшими биотехнологами. Обычные ранения на тебе заживают меньше, чем за день, а Критическое—за пару дней. В мед-капсулах ты лечишься в два раза быстрее, чем другие.'
                }
            ]
        },
        Cyborg: {
            preInfo: `Тао Прайм: Ты родился на Тао. С рождения твоё тело модифицировали кибер-имплантами. Когда общаешься с выходцем с Тао, можешь говорить так, что гайдзины вас не поймут. Выбери синдикат, который тебя вырастил:`,
            options: [
                {
                    button: 'Багровый лотос',
                    text: '«Смерть не является оправданием». Приказание должно быть выполнено несмотря ни на что. Когда ты испускаешь последний вздох, ты можешь заполнить 2 ячейки Бесчестия и сделать бросок успешным (10+).'
                },
                {
                    button: 'Стальной журавль',
                    text: '«Честь превыше Жизни». Под знаменами этого синдиката служат только безупречные. Когда ты по-ступил достойно, тут же очисти 1 ячейку Бесчестия. Очисти 2 ячейки, если поступил достойно и в соответствии с выбранными догматами.'
                },
                {
                    button: 'Чёрный лис',
                    text: '«Всё имеет свою цену». Пока у тебя есть хотя бы 1 заполненная ячейка Бесчестия, когда ты Сражаешься, то на 10+ можешь выбрать на 1 вариант больше из списка. Проиграв бой, немедленно заполни 1 ячейку Бесчестия.'
                }
            ]
        }
    }

    on("sheet:opened", function() {
        getAttrs(["character_class"], function(v) {
            update = {};
            if (v.character_class == null || v.character_class == "") {
                update["tip_confirm_flag"] = "0";
            } else {
                update["tip_confirm_flag"] = "1";
            }
            setAttrs(update);
        });
    });

    on("clicked:changeclass", function() {
        getSectionIDs("repeating_background", function(idarray) {
            for(var i=0; i < idarray.length; i++) {
              removeRepeatingRow("repeating_background_" + idarray[i]);
            }
         });
        setAttrs({
            tip_confirm_flag: 0,
            background: ' ',
            "background_show_flag": 0,
            "pre_background": ' '
        })
    })

    on("clicked:noble", function(eventinfo) {
        setupClass("Noble");
    });

    on("clicked:cyborg", function(eventinfo) {
        setupClass("Cyborg");
    });

    on("clicked:cancelclass", function(eventinfo) {
        setAttrs({tip_confirm_flag: 1}, "silent");
    });

    on('clicked:changebackground', function(eventInfo) {
        setAttrs({"background_show_flag": 0}, 'silent');
    });

    var addBackground = function(classname) {
        let data = backgrounds[classname]
        if (data) {
            if(data.preInfo) {
                setAttrs({pre_background: data.preInfo})
            }
            data.options.forEach(function(row) {
                var  newbackid = generateRowID();
                var prefix = "repeating_background_" + newbackid + "_";
                var attrs = {};
                attrs[prefix + "backgroundtext"] = row.text;
                attrs[prefix + "buttontext"] = row.button;
                setAttrs(attrs);
            })
        }
    }

    on('clicked:repeating_background:backgroundselect', function(eventInfo) {
        var id = eventInfo.sourceAttribute.slice(21, -17);
        var text = `repeating_background_${id}_backgroundtext`;
        var button = `repeating_background_${id}_buttontext`;
        getAttrs([button, text], (v) => {
			setAttrs({
                background: `${v[button]}: ${v[text]}`,
                background_show_flag: 1
			});
		});
    })



    on("change:page", function() {
        getAttrs(["page"], function(v) {
            setAttrs({calc_page:v.page});
        });
    });

    var setupClass = function(classname) {
        var update = {};
        update['character_class'] = classNames[classname]
        update['comp_name'] = classname
        update['description'] = descriptions[classname]
        update['tip_confirm_flag'] = 1
        addBackground(classname);
        setAttrs(update);
    };

</script>