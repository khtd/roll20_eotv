<div class="container">

    <div class="header-container">
        <img class="logo" src="https://github.com/khtd/roll20_eotv/blob/master/EotV_Logotype_3.png?raw=true">

        <div class="name-container">
            <span class="name-label">Имя</span>
            <input type="text" class="name-input" name="attr_character_name">
        </div>

        <div class="class-container">
            <span class="class-label">Класс</span>
            <input type="hidden" name="attr_comp_name">
            <input type="hidden" name="attr_comp_classmoves">
            <span class="class-span" name="attr_character_class"></span>
            <button type='action' class='change-button class-change-button' name='act_changeclass'>Изменить</button>
        </div>

        <div class="exp-container">
            <strong class="exp-label">EXP.</strong>
            <input type="checkbox" class="exp-box exp-box0" name="attr_exp" value="0" checked="checked">
            <input type="checkbox" class="exp-box exp-box1" name="attr_exp" value="1"><span class="exp-box1"></span>
            <input type="checkbox" class="exp-box exp-box2" name="attr_exp" value="2"><span class="exp-box2"></span>
            <input type="checkbox" class="exp-box exp-box3" name="attr_exp" value="3"><span class="exp-box3"></span>
            <input type="checkbox" class="exp-box exp-box4" name="attr_exp" value="4"><span class="exp-box4"></span>
            <strong class="exp-up-label">Уровень</strong>
            <input type="checkbox" class="exp-box exp-box5" name="attr_exp" value="5"><span class="exp-box5"></span>
         </div>
    </div>

    <div class="navigation-container">
        <div class="nav-tabs">
            <label class="nav-button">
                <input type="radio"  name="attr_page" value="page1" checked="checked">
                <span>лист 1</span>
            </label>
            <label class="nav-button">
                <input type="radio"  name="attr_page" value="page2">
                <span>лист 2</span>
            </label>
        </div>
    </div>
    <input type='hidden' class='tabstoggle' name='attr_sheetTab'  value='page1'/>


    <div class="page page1">
        <div class='description'>
            <span name="attr_description"></span>
        </div>

        <div class="background">
            <div class="title">
                <h3><span>ПРОИСХОЖДЕНИЕ</span></h3>
                <button type='action' class='change-button' name='act_changebackground'>p</button>
            </div>

            <input type="checkbox" class="is-cyborg-flag" name="attr_isCyborg" value="1" checked="false">
            <div class="additional-background cyborg-additional">
                <button type='roll' class="backgroundOutput infoOutput" name='roll_outAddBackground' value="&{template:info} {{name=@{character_name}}} {{type=Тао Прайм}} {{item=Происхождение}} {{description=Ты родился на Тао. С рождения твоё тело модифицировали кибер-имплантами. Когда общаешься с выходцем с Тао, можешь говорить так, что гайдзины вас не поймут.}}">w</button>
                <span><strong>Тао Прайм:</strong> Ты родился на Тао. С рождения твоё тело модифицировали кибер-имплантами. Когда общаешься с выходцем с Тао, можешь говорить так, что гайдзины вас не поймут.</span>
            </div>
            
            <div class="background-text">
                <button type='roll' class="backgroundOutput infoOutput" name='roll_outBackground' value="&{template:info} {{name=@{character_name}}} {{type=@{backgroundtype}}} {{item=Происхождение}} {{description=@{backgroundtext}}}">w</button>
                <strong><span name="attr_backgroundtype"></span>:</strong><span name="attr_backgroundtext"></span>
            </div>

           
            <input type="checkbox" class="background-show-flag" name="attr_background_show_flag" value="1">
            <div class='background-select'>
                <span class='emptiable' name="attr_pre_background"></span>
                <fieldset class='repeating_background'>
                    <button type="action" name="act_select" value='@{attr_button}'><span name='attr_button'></span></button>
                    <span name="attr_text"></span>
                </fieldset>
            </div>

        </div>

        <input type="checkbox" class="is-cyborg-flag" name="attr_isCyborg" value="1" checked="false">
        <div class='cyborg-additional cyborg-path'>
            <div class="title">
                <h3><span>ПУТЬ</span></h3>
                <button type='action' class='change-button' name='act_changecyborgPath'>p</button><br>
            </div>


            <div class="cyborgPath">
                <button type='roll' class="cyborgPathOutput infoOutput" name='roll_outCyborgPath' value="&{template:info} {{name=@{character_name}}} {{type=@{cyborgPathtype}}} {{item=Путь}} {{description=@{cyborgPathtext}}}">w</button>
                <strong><span name="attr_cyborgPathtype"></span>:</strong><span name="attr_cyborgPathtext"></span>
            </div>

            <input type="checkbox" class="cyborgPath-show-flag" name="attr_cyborgPath_show_flag" value="1" checked="false">
            <div class="cyborgPath-select">
                <span>Выбери мотив, который вынуждает тебя путешествовать:</span>
                <fieldset class='repeating_cyborgPath'>
                    <button type="action" name="act_select" value='@{attr_button}'><span name='attr_button'></span></button>
                    <span name="attr_text"></span>
                </fieldset>
            </div>
        </div>

        <div class='stranger-specialty'></div>

        <div class="look">
            <h3><span>ВНЕШНИЙ ВИД</span></h3>
            <textarea class="look-example" name="attr_look_example" readonly="true"></textarea>
            <textarea class="look-input" name='attr_look'></textarea>
        </div>
    </div>

    <div class="page page2">
        <div class="attributes">
            <div class='main-attributes'>
                <div class='furry attribute-container'>
                    <span class='attribute-name'>Ярость</span>
                    <input class='attribute-input' name='attr_furry' type='number'>
                </div>
                <div class='controll attribute-container'>
                    <span class='attribute-name'>Контроль</span>
                    <input class='attribute-input' name='attr_controll' type='number'>
                </div>
                <div class='skill attribute-container'>
                    <span class='attribute-name'>Навык</span>
                    <input class='attribute-input' name='attr_skill' type='number'>
                </div>
                <div class='reputation attribute-container'>
                    <span class='attribute-name'>Репутация</span>
                    <input class='attribute-input' name='attr_reputation' type='number'>
                </div>
            </div>

            <div class='sub-attributes'>
                <div class='atack sub-attribute-container'>
                    <span class='atack-lbl'>Атака</span>
                    <input type="checkbox" class="atack-box atack-box0" name="attr_atack" value="0" checked="checked">
                    <input type="checkbox" class="atack-box atack-box1" name="attr_atack" value="1"><span class="atack-box1"></span>
                    <input type="checkbox" class ="atack-max" name="attr_atack_max" value="1">
                    <input type="checkbox" class="atack-box atack-box2" name="attr_atack" value="2"><span class="atack-box2"></span>
                    <input type="checkbox" class ="atack-max" name="attr_atack_max" value="2">
                    <input type="checkbox" class="atack-box atack-box3" name="attr_atack" value="3"><span class="atack-box3"></span>
                    <input type="checkbox" class ="atack-max" name="attr_atack_max" value="3">
                    <input type="checkbox" class="atack-box atack-box4" name="attr_atack" value="4"><span class="atack-box4"></span>
                    <input type="checkbox" class ="atack-max" name="attr_atack_max" value="4">
                    <input type="checkbox" class="atack-box atack-box5" name="attr_atack" value="5"><span class="atack-box5"></span>
                    <input type="checkbox" class ="atack-max" name="attr_atack_max" value="5">
                    <button type="action" class="addatackbutton" name='act_addmaxatack'>&</button>
                    <button type="action" class="sbstrctatackbutton" name='act_subtractmaxatack'>_</button>
                </div>

                <div class='armor sub-attribute-container'>
                    <span class='armor-lbl'>Броня</span>
                    <input type="checkbox" class="armor-box armor-box0" name="attr_armor" value="0" checked="checked">
                    <input type="checkbox" class="armor-box armor-box1" name="attr_armor" value="1"><span class="armor-box1"></span>
                    <input type="checkbox" class ="armor-max" name="attr_armor_max" value="1">
                    <input type="checkbox" class="armor-box armor-box2" name="attr_armor" value="2"><span class="armor-box2"></span>
                    <input type="checkbox" class ="armor-max" name="attr_armor_max" value="2">
                    <input type="checkbox" class="armor-box armor-box3" name="attr_armor" value="3"><span class="armor-box3"></span>
                    <input type="checkbox" class ="armor-max" name="attr_armor_max" value="3">
                    <input type="checkbox" class="armor-box armor-box4" name="attr_armor" value="4"><span class="armor-box4"></span>
                    <input type="checkbox" class ="armor-max" name="attr_armor_max" value="4">
                    <input type="checkbox" class="armor-box armor-box5" name="attr_armor" value="5"><span class="armor-box5"></span>
                    <input type="checkbox" class ="armor-max" name="attr_armor_max" value="5">
                    <button type="action" class="addarmorbutton" name='act_addmaxarmor'>&</button>
                    <button type="action" class="sbstrctarmorbutton" name='act_subtractmaxarmor'>_</button>
                </div>

                <div class='hp sub-attribute-container'>
                    <span class='hp-lbl'>Здоровье</span>
                    <input type="checkbox" class="hp-box hp-box0" name="attr_hp" value="0" checked="checked">
                    <input type="checkbox" class="hp-box hp-box1" name="attr_hp" value="1"><span class="hp-box1"></span>
                    <input type="checkbox" class ="hp-max" name="attr_hp_max" value="1">
                    <input type="checkbox" class="hp-box hp-box2" name="attr_hp" value="2"><span class="hp-box2"></span>
                    <input type="checkbox" class ="hp-max" name="attr_hp_max" value="2">
                    <input type="checkbox" class="hp-box hp-box3" name="attr_hp" value="3"><span class="hp-box3"></span>
                    <input type="checkbox" class ="hp-max" name="attr_hp_max" value="3">
                    <input type="checkbox" class="hp-box hp-box4" name="attr_hp" value="4"><span class="hp-box4"></span>
                    <input type="checkbox" class ="hp-max" name="attr_hp_max" value="4">
                    <input type="checkbox" class="hp-box hp-box5" name="attr_hp" value="5"><span class="hp-box5"></span>
                    <input type="checkbox" class ="hp-max" name="attr_hp_max" value="5">
                    <button type="action" class="addhpbutton" name='act_addmaxhp'>&</button>
                    <button type="action" class="sbstrcthpbutton" name='act_subtractmaxhp'>_</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Start welcome -->

<input type="checkbox" class="tip-confirm-flag" name="attr_tip_confirm_flag" value="1">
<div class="class-tip">
	<button type="action" class="cancel-button" name="act_cancelclass">&#128473;</button>
	<h3><span>Getting Started</span></h3>
	<p><span>Welcome to the Edge of The Verse Character Sheet!  To get started select class from the choices below:</span></p>
	<button type="action" name="act_noble">Аристократ</button>
	<button type="action" name="act_cyborg">Киборг</button>
</div>

<rolltemplate class="sheet-rolltemplate-info">
    <div class="sheet-templateMain">
        <h2 class="sheet-templateheader">{{name}}</h2>
        <h3 class="sheet-templatesubheader">{{item}}{{#type}} ({{type}}){{/type}}</h3>
        <div class="sheet-templatedescription">
            {{#description}}{{description}}{{/description}}
			{{#allprops() description item type}}<p><strong>{{key}}:</strong> {{value}}</p>{{/allprops() description item type}}
        </div>
    </div>
</rolltemplate>

<!-- type="text/worker" -->
<script type="text/worker">
    var classNames = {
        Noble: 'Аристократ',
        Cyborg: 'Киборг'
    }

    var descriptions = {
        Noble: `Хотя Федерация и пытается всеми силами оспорить первенство Империи, все-таки стоит признать, что после Дня Агонии именно последняя сумела по максимуму сохранить свои традиции и устои. Немаловажную роль в этом сыграли аристократы — привилегированный класс дворян, правящих доменами, из которых состоят миры под властью Императрицы. Но для тебя все сложилось иначе. У тебя нет собственного домена, а потому тебе предстоит самостоятельно найти место в этом мире. Но у тебя всё ещё остались честь, происхождение и жажда власти. А галактика — достаточно непредсказуемое место для того, чтобы дерзкий и смелый юноша мог в итоге сорвать куш и вернуться на родину баснословно богатым аристократом`,
        Cyborg: 'В обществе, где всё направлено на развитие личной эффективности на службе Синдикату, биологические процессы признаны отсталыми. Первая имплантация проводится вскоре после рождения, а модульная платформа позволяет затем изменять и настраивать собственное тело в течение всей жизни. Да, киборгов умеют делать и в других уголках галактики, но только на Тао Прайм это возведено в смысл жизни. Этот процесс как-то уживается с жёстким следованием кодексу чести и неукоснительным соблюдением многочисленных заповедей и табу. Не все выдерживают строгость этих правил.'
    }

    var look = {
        Noble: `Хитрый, надёжный или невинный взгляд
Атлет, рыхлое или красивое тело
Короткие волосы, стильная причёска или дорогая шляпа
Роскошный наряд, мундир или деловой костюм`,
        Cyborg: `Раскосые, «анимешные» или искусственные глаза
Фиолетовые, наращённые или искусственные волосы
Кукольное, роботизированное или крепкое телосложение
Трубки из головы, кибер-конечность или синтокожа`,
    }

    var backgrounds = {
        Noble: {
            preInfo: 'Выбери правящий дом, в котором ты рожден:',
            options: [
                {
                    button: 'Дом Адана',
                    text: 'Фехтование входит в обязательную программу обучения Дома. Твой Урон в ближнем бою увеличен на 1.'
                },
                {
                    button: 'Дом Акоста',
                    text: 'Сражаясь один на один в ближнем бою, ты можешь использовать Репутацию вместо Ярости.'
                },
                {
                    button: 'Дом Алуат',
                    text: 'Спокойный дом, склонный к наблюдению. Когда ты успешно Ориентируешься, задай на 1 вопрос больше.'
                },
                {
                    button: 'Дом Анхил',
                    text: 'Ты свой человек в криминальном мире. Потрать 1 Припас и поменяй в своём ID имя и другие данные.'
                },
                {
                    button: 'Дом Астор',
                    text: 'Твой дом баснословно влиятелен. Раз в сессию, когда Договариваешься, получи 10+. Рычаг всё ещё нужен.'
                },
                {
                    button: 'Дом Дега Росса',
                    text: 'Дом понимает в снабжении. Раз в сессию можешь достать любой не очень редкий предмет. Опиши, откуда.'
                },
                {
                    button: 'Малый дом',
                    text: 'Один раз за сессию ты можешь превратить 6— в 7—9 или 7—9 в 10+, если это пойдет на пользу Дому.'
                },
                {
                    button: 'Кастонианская марка',
                    text: 'Бароны и баронессы — самые гордые люди на свете. Когда ты Помогаешь, один раз в сессию ты можешь превратить проверку союзника в 10+.'
                },
                {
                    button: 'Эмираты Эльхали',
                    text: 'Ты — клон самого эмира, созданный лучшими биотехнологами. Обычные ранения на тебе заживают меньше, чем за день, а Критическое—за пару дней. В мед-капсулах ты лечишься в два раза быстрее, чем другие.'
                }
            ]
        },
        Cyborg: {
            preInfo: `Выбери синдикат, который тебя вырастил:`,
            options: [
                {
                    button: 'Багровый лотос',
                    text: '«Смерть не является оправданием». Приказание должно быть выполнено несмотря ни на что. Когда ты испускаешь последний вздох, ты можешь заполнить 2 ячейки Бесчестия и сделать бросок успешным (10+).'
                },
                {
                    button: 'Стальной журавль',
                    text: '«Честь превыше Жизни». Под знаменами этого синдиката служат только безупречные. Когда ты по-ступил достойно, тут же очисти 1 ячейку Бесчестия. Очисти 2 ячейки, если поступил достойно и в соответствии с выбранными догматами.'
                },
                {
                    button: 'Чёрный лис',
                    text: '«Всё имеет свою цену». Пока у тебя есть хотя бы 1 заполненная ячейка Бесчестия, когда ты Сражаешься, то на 10+ можешь выбрать на 1 вариант больше из списка. Проиграв бой, немедленно заполни 1 ячейку Бесчестия.'
                }
            ]
        }
    }

    var special = {
        Cyborg: {
            cyborgPath: [
                {
                    button: 'Буси',
                    text: 'Ты — воин сёгуна, преумножающий свою славу и честь синдиката. Твоя цель — показать себя с лучшей стороны и на фоне гайдзинов продемонстрировать превосходство Тао.'
                },
                {
                    button: 'Ронин',
                    text: 'Ты совершил ошибку и покрыл себя позором (или тебя подставили). Ты изгнан из синдиката и скитаешься по Галактике в надежде восстановить свою честь, найти новый дом или умереть достойно.'
                }
            ]
        }
    }

    on("sheet:opened", function() {
        getAttrs(["character_class"], function(v) {
            update = {};
            if (v.character_class == null || v.character_class == "") {
                update["tip_confirm_flag"] = "0";
            } else {
                update["tip_confirm_flag"] = "1";
            }
            setAttrs(update);
        });
    });

    on("change:page", function() {
        getAttrs(["page"], function(v) {
            setAttrs({sheetTab:v.page});
        });
    });

    on("clicked:changeclass", function() {
        getSectionIDs("repeating_background", function(idarray) {
            for(var i=0; i < idarray.length; i++) {
              removeRepeatingRow("repeating_background_" + idarray[i]);
            }
         });
         getSectionIDs("repeating_cyborgPath", function(idarray) {
            for(var i=0; i < idarray.length; i++) {
              removeRepeatingRow("repeating_cyborgPath_" + idarray[i]);
            }
         });
        setAttrs({
            tip_confirm_flag: 0,
            description: ' ',
            backgroundtype: ' ',
            backgroundtext: ' ',
            cyborgPathtype: ' ',
            cyborgPathtext: ' ',
            look_example: ' ',
            character_class: ' ',
            comp_name: ' ',
            "background_show_flag": 0,
            "pre_background": ' ',
            isCyborg: 1
        })
    })

    on("clicked:noble", function(eventinfo) {
        setupClass("Noble");
    });

    on("clicked:cyborg", function(eventinfo) {
        var update = addRepeatingInfo(special.Cyborg.cyborgPath, 'cyborgPath')
        update.isCyborg = 0;
        update.cyborgPath_show_flag = 0
        setAttrs(update, undefined, function() {setupClass("Cyborg")})
    });

    var addRepeatingInfo = function(options, param) {
        var update = {}
        options.forEach(function(row) {
            var  newbackid = generateRowID();
            var prefix = `repeating_${param}_${newbackid}_`;
            update[`${prefix}text`] = row.text;
            update[`${prefix}button`] = row.button;
        })
        return update;
    }

    on("clicked:cancelclass", function(eventinfo) {
        setAttrs({tip_confirm_flag: 1}, "silent");
    });

    on('clicked:changebackground', function(eventInfo) {
        setAttrs({"background_show_flag": 0}, 'silent');
    });

    on('clicked:repeating_background:select', function() {
        getAttrs(["repeating_background_button", "repeating_background_text"], (v) => {
			setAttrs({
                backgroundtype: v.repeating_background_button,
                backgroundtext: v.repeating_background_text,
                background_show_flag: 1
			});
		});
    })

    on('clicked:changecyborgPath', function() {
        setAttrs({"cyborgPath_show_flag": 0}, 'silent');
    });

    on('clicked:repeating_cyborgPath:select', () => {
        getAttrs(["repeating_cyborgPath_button", "repeating_cyborgPath_text"], (v) => {
			setAttrs({
                cyborgPathtype: v.repeating_cyborgPath_button,
                cyborgPathtext: v.repeating_cyborgPath_text,
                cyborgPath_show_flag: 1
			});
		});
    })

    var setupClass = function(classname) {
        var update = {};
        update['character_class'] = classNames[classname]
        update['comp_name'] = classname
        update['description'] = descriptions[classname]
        update['look_example'] = look[classname]
        update['tip_confirm_flag'] = 1
        var backgroundUpdate = addRepeatingInfo(backgrounds[classname].options, 'background')
        if(backgrounds[classname].preInfo) {
            backgroundUpdate.pre_background = backgrounds[classname].preInfo
        }
        setAttrs({...update, ...backgroundUpdate});
    };

    on('clicked:subtractmaxatack', ()=> {
        getAttrs(['atack_max', 'atack'], (v) => {
            let update = {};
            update.atack_max = parseInt(v.atack_max) -1 < 1 ? 1 : parseInt(v.atack_max) - 1
            if(parseInt(v.atack_max) -1 < parseInt(v.atack)) {
                update.atack = parseInt(v.atack_max) -1
            }
            setAttrs(update);
        })
    })

    on('clicked:addmaxatack', ()=> {
        getAttrs(['atack_max'], (v) => {
            var update = {
                atack_max: parseInt(v.atack_max) + 1 > 5 ? 5 : parseInt(v.atack_max) + 1
            }
            setAttrs(update);
        })
    })

    on('clicked:subtractmaxarmor', ()=> {
        getAttrs(['armor_max', 'armor'], (v) => {
            let update = {};
            update.armor_max = parseInt(v.armor_max) -1 < 1 ? 1 : parseInt(v.armor_max) - 1
            if(parseInt(v.armor_max) -1 < parseInt(v.armor)) {
                update.armor = parseInt(v.armor_max) -1
            }
            setAttrs(update);
        })
    })

    on('clicked:addmaxarmor', ()=> {
        getAttrs(['armor_max'], (v) => {
            var update = {
                armor_max: parseInt(v.armor_max) + 1 > 5 ? 5 : parseInt(v.armor_max) + 1
            }
            setAttrs(update);
        })
    })

    on('clicked:subtractmaxhp', ()=> {
        getAttrs(['hp_max', 'hp'], (v) => {
            let update = {};
            update.hp_max = parseInt(v.hp_max) -1 < 1 ? 1 : parseInt(v.hp_max) - 1
            if(parseInt(v.hp_max) -1 < parseInt(v.hp)) {
                update.hp = parseInt(v.hp_max) -1
            }
            setAttrs(update);
        })
    })

    on('clicked:addmaxhp', ()=> {
        getAttrs(['hp_max'], (v) => {
            var update = {
                hp_max: parseInt(v.hp_max) + 1 > 5 ? 5 : parseInt(v.hp_max) + 1
            }
            setAttrs(update);
        })
    })

</script>